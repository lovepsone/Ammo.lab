'use strict';var Module={TOTAL_MEMORY:268435456},Ammo,start,terrains,world=null,worldInfo=null,solver,solverSoft,collision,dispatcher,broadphase,ghostPairCallback,isSoft=!0,trans,pos,quat,posW,quatW,transW,gravity,tmpTrans,tmpPos,tmpQuat,tmpPos1,tmpPos2,tmpPos3,tmpPos4,tmpTrans1,tmpTrans2,tmpForce=[],tmpMatrix=[],bodys,solids,softs,joints,cars,heros,carsInfo,byName,timeStep=1/60,timerStep=1E3*timeStep,substep=2,ddt=1,key=[0,0,0,0,0,0,0,0],tmpKey=[0,0,0,0,0,0,0,0],pause=!0,isBuffer,isDynamic,currentCar=
0,Ar,aAr,ArLng,ArPos,ArMax,fixedTime=0.01667,last_step=Date.now(),timePassed=0,STATE={ACTIVE:1,ISLAND_SLEEPING:2,WANTS_DEACTIVATION:3,DISABLE_DEACTIVATION:4,DISABLE_SIMULATION:5},FLAGS={STATIC_OBJECT:1,KINEMATIC_OBJECT:2,NO_CONTACT_RESPONSE:4,CUSTOM_MATERIAL_CALLBACK:8,CHARACTER_OBJECT:16,DISABLE_VISUALIZE_OBJECT:32,DISABLE_SPU_COLLISION_PROCESSING:64},GROUP={DEFAULT:1,STATIC:2,KINEMATIC:4,DEBRIS:8,SENSORTRIGGER:16,NOCOLLISION:32,GROUP0:64,GROUP1:128,GROUP2:256,GROUP3:512,GROUP4:1024,GROUP5:2048,
GROUP6:4096,GROUP7:8192,ALL:-1};function initARRAY(){aAr=new ArrayBuffer(ArMax*Float32Array.BYTES_PER_ELEMENT);Ar=new Float32Array(aAr)}
self.onmessage=function(a){a=a.data;switch(a.m){case "init":init(a);break;case "step":step(a);break;case "start":start(a);break;case "reset":reset(a);break;case "key":tmpKey=a.o.key;break;case "setDriveCar":currentCar=a.o.n;break;case "substep":substep=a.o.substep;break;case "moveSoftBody":moveSoftBody(a.o);break;case "heroRotation":setHeroRotation(a.o.id,a.o.angle);break;case "add":add(a.o);break;case "vehicle":addVehicle(a.o);break;case "character":addCharacter(a.o);break;case "terrain":terrainPostStep(a.o);
break;case "gravity":setGravity(a.o);break;case "anchor":anchor(a.o);break;case "forces":tmpForce=a.o.r;break;case "matrix":tmpMatrix=a.o.r}};function preStep(){}
function step(a){pause||(key=a.key,updateMatrix(),updateForce(),terrainUpdate(),isBuffer&&(aAr=a.aAr,Ar=new Float32Array(aAr)),world.stepSimulation(timeStep,substep),drive(currentCar),move(0),stepCharacter(Ar,ArPos[0]),stepVehicle(Ar,ArPos[1]),stepRigidBody(Ar,ArPos[2]),stepSoftBody(Ar,ArPos[3]),stepConstraint(Ar,ArPos[4]),isBuffer?self.postMessage({m:"step",aAr:aAr},[aAr]):self.postMessage({m:"step",Ar:Ar}))}
function init(a){isBuffer=a.isBuffer||!1;isDynamic=a.isDynamic||!1;void 0!==a.timeStep&&(timeStep=a.timeStep);timerStep=1E3*timeStep;substep=a.substep||2;ArLng=a.settings[0];ArPos=a.settings[1];ArMax=a.settings[2];importScripts(a.blob);Ammo().then(function(a){console.log("Ammo init");initMath();trans=new a.btTransform;quat=new a.btQuaternion;pos=new a.btVector3;posW=new a.btVector3;quatW=new a.btQuaternion;transW=new a.btTransform;tmpTrans=new a.btTransform;tmpPos=new a.btVector3;tmpQuat=new a.btQuaternion;
tmpPos1=new a.btVector3;tmpPos2=new a.btVector3;tmpPos3=new a.btVector3;tmpPos4=new a.btVector3;tmpTrans1=new a.btTransform;tmpTrans2=new a.btTransform;gravity=new a.btVector3;addWorld();bodys=[];softs=[];joints=[];cars=[];carsInfo=[];heros=[];solids=[];byName={};self.postMessage({m:"init"})})}
function reset(a){pause=!0;tmpForce=[];clearJoint();clearRigidBody();clearVehicle();clearCharacter();clearSoftBody();byName={};a.full&&(clearWorld(),addWorld());setGravity();pause=!1;isBuffer?(initARRAY(),self.postMessage({m:"start",aAr:aAr},[aAr])):(initARRAY(),self.postMessage({m:"start"}))}function wipe(a){for(var b in a)a.hasOwnProperty(b)&&delete a[b]}
function add(a,b){a.type=void 0===a.type?"box":a.type;var d=a.type,c=a.type.substring(0,4);"join"===c?addJoint(a):"soft"===c||"ellipsoid"===d||"rope"===d||"cloth"===d?addSoftBody(a):"terrain"===d?addTerrain(a):addRigidBody(a,b)}function anchor(a){getByName(a.soft).appendAnchor(a.pos,getByName(a.body),!1,a.influence||0.5)}
function addRay(a){void 0!==a.p1&&tmpPos1.fromArray(a.p1);void 0!==a.p2&&tmpPos2.fromArray(a.p2);a=new Ammo.ClosestRayResultCallback(tmpPos1,tmpPos2);world.rayTest(tmpPos1,tmpPos2,a)}function getByName(a){return byName[a]||null}function getByIdx(a){a=a.toFixed(1);var b=parseInt(a);switch(Number(a.substring(a.lastIndexOf(".")+1))){case 1:return heros[b];case 2:return cars[b];case 3:return bodys[b];case 4:return solids[b];case 5:return terrains[b];case 6:return softs[b];case 7:return joints[b]}}
function updateForce(){for(var a=tmpForce.length;a--;)applyForce(tmpForce[a][0],tmpForce[a][1],tmpForce[a][2],tmpForce[a][3]);tmpForce=[]}
function applyForce(a,b,d,c){var e=getByName(a);null===e&&(e=getByIdx(a));if(null!==e)switch(tmpPos1.fromArray(d),tmpPos2.fromArray(c),b){case "force":case 0:e.applyForce(tmpPos1,tmpPos2);break;case "torque":case 1:e.applyTorque(tmpPos1);break;case "localTorque":case 2:e.applyLocalTorque(tmpPos1);break;case "centralForce":case 3:e.applyCentralForce(tmpPos1);break;case "centralLocalForce":case 4:e.applyCentralLocalForce(tmpPos1);break;case "impulse":case 5:e.applyImpulse(tmpPos1,tmpPos2);break;case "centralImpulse":case 6:e.applyCentralImpulse(tmpPos1);
break;case "motor":case 7:e.enableAngularMotor(!0,d[0],d[1])}}function updateMatrix(){for(;0<tmpMatrix.length;)applyMatrix(tmpMatrix.pop())}function applyMatrix(a){var b=getByName(a[0]);null!==b&&(tmpTrans.setIdentity(),void 0!==a[1]&&(tmpPos.fromArray(a[1]),tmpTrans.setOrigin(tmpPos)),void 0!==a[2]&&(tmpQuat.fromArray(a[2]),tmpTrans.setRotation(tmpQuat)),b.getMotionState().setWorldTransform(tmpTrans))}
function clearWorld(){Ammo.destroy(world);Ammo.destroy(solver);Ammo.destroy(solverSoft);Ammo.destroy(collision);Ammo.destroy(dispatcher);Ammo.destroy(broadphase);world=null}
function addWorld(a){a=a||{};if(null===world){isSoft=void 0===a.soft?!0:a.soft;solver=new Ammo.btSequentialImpulseConstraintSolver;solverSoft=isSoft?new Ammo.btDefaultSoftBodySolver:null;collision=isSoft?new Ammo.btSoftBodyRigidBodyCollisionConfiguration:new Ammo.btDefaultCollisionConfiguration;dispatcher=new Ammo.btCollisionDispatcher(collision);switch(void 0===a.broadphase?2:a.broadphase){case 1:broadphase=new Ammo.btAxisSweep3(new Ammo.btVector3(-1E3,-1E3,-1E3),new Ammo.btVector3(1E3,1E3,1E3),
4096);break;case 2:broadphase=new Ammo.btDbvtBroadphase}world=isSoft?new Ammo.btSoftRigidDynamicsWorld(dispatcher,broadphase,solver,collision,solverSoft):new Ammo.btDiscreteDynamicsWorld(dispatcher,broadphase,solver,collision);world.getDispatchInfo().set_m_allowedCcdPenetration(0.001);setGravity(a)}}
function setGravity(a){a=a||{};null!==world&&(gravity.fromArray(a.g||[0,-10,0]),world.setGravity(gravity),isSoft&&(worldInfo=world.getWorldInfo(),worldInfo.set_air_density(a.air||1.2),worldInfo.set_m_gravity(gravity),setWater(a)))}function setWater(a){isSoft&&(worldInfo=world.getWorldInfo(),worldInfo.set_water_density(a.density||0),worldInfo.set_water_offset(a.offset||0),worldInfo.set_water_normal((new Ammo.btVector3).fromArray(a.normal||[0,0,0])))};var torad=0.017453292519943295,todeg=57.29577951308232;
function initMath(){Ammo.btTransform.prototype.toArray=function(a,b){b=b||0;this.getOrigin().toArray(a,b);this.getRotation().toArray(a,b+3)};Ammo.btVector3.prototype.negate=function(a){this.setValue(-this.x(),-this.y(),-this.z());return this};Ammo.btVector3.prototype.add=function(a){this.setValue(this.x()+a.x(),this.y()+a.y(),this.z()+a.z());return this};Ammo.btVector3.prototype.fromArray=function(a,b){b=b||0;this.setValue(a[b],a[b+1],a[b+2]);return this};Ammo.btVector3.prototype.toArray=function(a,
b){b=b||0;a[b]=this.x();a[b+1]=this.y();a[b+2]=this.z()};Ammo.btVector3.prototype.direction=function(a){var b=a.x(),d=a.y(),c=a.z();a=a.w();var e=this.x(),f=this.y(),h=this.z(),g=a*e+d*h-c*f,p=a*f+c*e-b*h,k=a*h+b*f-d*e,e=-b*e-d*f-c*h;this.setValue(g*a+e*-b+p*-c-k*-d,p*a+e*-d+k*-b-g*-c,k*a+e*-c+g*-d-p*-b)};Ammo.btQuaternion.prototype.fromArray=function(a,b){b=b||0;this.setValue(a[b],a[b+1],a[b+2],a[b+3])};Ammo.btQuaternion.prototype.toArray=function(a,b){b=b||0;a[b]=this.x();a[b+1]=this.y();a[b+2]=
this.z();a[b+3]=this.w()};Ammo.btQuaternion.prototype.setFromAxisAngle=function(a,b){var d=0.5*b,c=Math.sin(d);this.setValue(a[0]*c,a[1]*c,a[2]*c,Math.cos(d))}};function stepCharacter(a,b){heros.forEach(function(d,c){var e=b+8*c;a[e]=d.speed;var f=d.getGhostObject().getWorldTransform();pos=f.getOrigin();quat=f.getRotation();a[e+1]=pos.x();a[e+2]=pos.y();a[e+3]=pos.z();a[e+4]=quat.x();a[e+5]=quat.y();a[e+6]=quat.z();a[e+7]=quat.w()})}function clearCharacter(){for(var a;0<heros.length;)a=heros.pop(),world.removeCollisionObject(a.getGhostObject()),Ammo.destroy(a.getGhostObject()),world.removeAction(a),Ammo.destroy(a);heros=[]}
function addCharacter(a){a.size=void 0==a.size?[1,1,1]:a.size;a.pos=void 0==a.pos?[0,0,0]:a.pos;a.quat=void 0==a.quat?[0,0,0,1]:a.quat;var b=new Ammo.btCapsuleShape(a.size[0],0.5*a.size[1]),d=new Ammo.btPairCachingGhostObject;d.setCollisionShape(b);d.setCollisionFlags(FLAGS.CHARACTER_OBJECT);tmpPos.fromArray(a.pos);tmpQuat.fromArray(a.quat);tmpTrans.setIdentity();tmpTrans.setOrigin(tmpPos);tmpTrans.setRotation(tmpQuat);d.setWorldTransform(tmpTrans);d.setFriction(a.friction||0.1);d.setRestitution(a.restitution||
0);d.setActivationState(4);d.activate();var c=new Ammo.btKinematicCharacterController(d,b,a.stepH||0.35,a.upAxis||1);c.setUseGhostSweepTest(b);c.setGravity(gravity);c.setFallSpeed(30);c.rotation=0;c.speed=0;c.wasJumping=!1;c.verticalVelocity=0;c.setMaxJumpHeight(200);c.setJumpSpeed(1E3);a.slopeRadians&&c.setMaxSlope(a.slopeRadians);tmpPos2.setValue(0,0,0);c.setVelocityForTimeInterval(tmpPos2,1);world.addCollisionObject(d,a.group||1,a.mask||-1);world.addAction(c);heros.push(c)}
function setHeroRotation(a,b){var d=heros[a].getGhostObject().getWorldTransform();quatW.setFromAxisAngle([0,1,0],b);d.setRotation(quatW);heros[a].rotation=b}
function move(a){a=a||0;if(heros[a]){var b=heros[a],d=0,c=0;1==key[4]&&b.onGround()&&(b.wasJumping=!0,b.verticalVelocity=0);b.wasJumping&&(b.verticalVelocity+=0.04,1.3<b.verticalVelocity&&(b.verticalVelocity=0,b.wasJumping=!1));c=0.3*-key[1];d=0.3*-key[0];b.speed=c+d;b.rotation-=0.1*key[2];setHeroRotation(a,b.rotation);posW.setValue(d,0+b.verticalVelocity,c);posW.direction(quatW);b.setWalkDirection(posW)}};function stepConstraint(a,b){joints.forEach(function(d,c){var e=b+4*c;d.type&&(a[e]=d.type)})}function clearJoint(){for(var a;0<joints.length;)a=joints.pop(),world.removeConstraint(a),Ammo.destroy(a);joints=[]}
function addJoint(a){var b=!0;a.collision&&(b=!1);var d=getByName(a.body1),c=getByName(a.body2);tmpPos1.fromArray(a.pos1||[0,0,0]);tmpPos2.fromArray(a.pos2||[0,0,0]);tmpPos3.fromArray(a.axe1||[1,0,0]);tmpPos4.fromArray(a.axe2||[1,0,0]);"joint_p2p"!==a.type&&"joint_hinge"!==a.type&&"joint"!==a.type&&(tmpTrans1.setIdentity(),tmpTrans1.setOrigin(tmpPos1),a.quatA&&(tmpQuat.fromArray(a.quatA),tmpTrans1.setRotation(tmpQuat)),tmpTrans2.setIdentity(),tmpTrans2.setOrigin(tmpPos2),a.quatB&&(tmpQuat.fromArray(a.quatB),
tmpTrans2.setRotation(tmpQuat)));var e=void 0!==a.useA?a.useA:!0,f=null,h=0;switch(a.type){case "joint_p2p":h=1;f=new Ammo.btPoint2PointConstraint(d,c,tmpPos1,tmpPos2);a.strength&&f.get_m_setting().set_m_tau(a.strength);a.damping&&f.get_m_setting().set_m_damping(a.damping);a.impulse&&f.get_m_setting().set_m_impulseClamp(a.impulse);break;case "joint_hinge":case "joint":h=2;f=new Ammo.btHingeConstraint(d,c,tmpPos1,tmpPos2,tmpPos3,tmpPos4,e);break;case "joint_slider":h=3;f=new Ammo.btSliderConstraint(d,
c,tmpTrans1,tmpTrans2,e);break;case "joint_conetwist":h=4;f=new Ammo.btConeTwistConstraint(d,c,tmpTrans1,tmpTrans2);break;case "joint_dof":h=5;f=new Ammo.btGeneric6DofConstraint(d,c,tmpTrans1,tmpTrans2,e);break;case "joint_spring_dof":h=6,f=new Ammo.btGeneric6DofSpringConstraint(d,c,tmpTrans1,tmpTrans2,e)}a.breaking&&f.setBreakingImpulseThreshold(a.breaking);a.limit&&("joint_hinge"===a.type||"joint"===a.type?f.setLimit(a.limit[0]*torad,a.limit[1]*torad,a.limit[2]||0.9,a.limit[3]||0.3,a.limit[4]||
1):"joint_conetwist"===a.type&&f.setLimit(a.limit[0]*torad,a.limit[1]*torad,a.limit[2]*torad,a.limit[3]||0.9,a.limit[4]||0.3,a.limit[5]||1));a.motor&&f.enableAngularMotor(a.motor[0],a.motor[1],a.motor[2]);a.linLower&&(tmpPos.fromArray(a.linLower),f.setLinearLowerLimit(tmpPos));a.linUpper&&(tmpPos.fromArray(a.linUpper),f.setLinearUpperLimit(tmpPos));a.angLower&&(tmpPos.fromArray(a.angLower),f.setAngularLowerLimit(tmpPos));a.angUpper&&(tmpPos.fromArray(a.angUpper),f.setAngularUpperLimit(tmpPos));a.feedback&&
f.enableFeedback(a.feedback);a.enableSpring&&f.enableSpring(a.enableSpring[0],a.enableSpring[1]);a.damping&&f.setDamping(a.damping[0],a.damping[1]);a.stiffness&&f.setStiffness(a.stiffness[0],a.stiffness[1]);a.angularOnly&&f.setAngularOnly(a.angularOnly);a.enableMotor&&f.enableMotor(a.enableMotor);a.maxMotorImpulse&&f.setMaxMotorImpulse(a.maxMotorImpulse);a.motorTarget&&f.setMotorTarget(tmpQuat.fromArray(a.motorTarget));f.type=0;a.debug&&(f.type=h,f.bodyA=d,f.bodyB=c);world.addConstraint(f,b);a.name&&
(byName[a.name]=f);joints.push(f)};function stepRigidBody(a,b){bodys.forEach(function(d,c){var e=b+8*c;a[e]=9.8*d.getLinearVelocity().length();0<a[e]&&(d.getMotionState().getWorldTransform(trans),trans.toArray(a,e+1))})}function clearRigidBody(){for(var a;0<bodys.length;)a=bodys.pop(),world.removeRigidBody(a),Ammo.destroy(a);for(;0<solids.length;)a=solids.pop(),world.removeCollisionObject(a),Ammo.destroy(a);bodys=[];solids=[]}
function addRigidBody(a,b){a.mass=void 0==a.mass?0:a.mass;a.size=void 0==a.size?[1,1,1]:a.size;a.pos=void 0==a.pos?[0,0,0]:a.pos;a.quat=void 0==a.quat?[0,0,0,1]:a.quat;var d=null;switch(a.type){case "plane":tmpPos4.fromArray(a.dir||[0,1,0]);d=new Ammo.btStaticPlaneShape(tmpPos4,0);break;case "box":tmpPos4.setValue(0.5*a.size[0],0.5*a.size[1],0.5*a.size[2]);d=new Ammo.btBoxShape(tmpPos4);break;case "sphere":d=new Ammo.btSphereShape(a.size[0]);break;case "cylinder":tmpPos4.setValue(a.size[0],0.5*a.size[1],
0.5*a.size[2]);d=new Ammo.btCylinderShape(tmpPos4);break;case "cone":d=new Ammo.btConeShape(a.size[0],0.5*a.size[1]);break;case "capsule":d=new Ammo.btCapsuleShape(a.size[0],0.5*a.size[1]);break;case "compound":d=new Ammo.btCompoundShape;break;case "mesh":for(var d=new Ammo.btTriangleMesh,c=a.v,e=0,f=c.length;e<f;e+=9)tmpPos1.setValue(c[e+0]*a.size[0],c[e+1]*a.size[1],c[e+2]*a.size[2]),tmpPos2.setValue(c[e+3]*a.size[0],c[e+4]*a.size[1],c[e+5]*a.size[2]),tmpPos3.setValue(c[e+6]*a.size[0],c[e+7]*a.size[1],
c[e+8]*a.size[2]),d.addTriangle(tmpPos1,tmpPos2,tmpPos3,!0);d=0==a.mass?new Ammo.btBvhTriangleMeshShape(d,!0,!0):new Ammo.btConvexTriangleMeshShape(d,!0);break;case "convex":for(d=new Ammo.btConvexHullShape,c=a.v,e=0,f=c.length;e<f;e+=3)c[e]*=a.size[0],c[e+1]*=a.size[1],c[e+2]*=a.size[2],tmpPos1.fromArray(c,e),d.addPoint(tmpPos1)}void 0!==a.margin&&void 0!==d.setMargin&&d.setMargin(a.margin);if("isShape"==b)return d;if("isGhost"==b)return c=new Ammo.btGhostObject,c.setCollisionShape(d),c;tmpPos.fromArray(a.pos);
tmpQuat.fromArray(a.quat);tmpTrans.setIdentity();tmpTrans.setOrigin(tmpPos);tmpTrans.setRotation(tmpQuat);tmpPos1.setValue(0,0,0);d.calculateLocalInertia(a.mass,tmpPos1);c=new Ammo.btDefaultMotionState(tmpTrans);d=new Ammo.btRigidBodyConstructionInfo(a.mass,c,d,tmpPos1);a.friction=void 0==a.friction?0.5:a.friction;a.restitution=void 0==a.restitution?0:a.restitution;d.set_m_friction(a.friction||0.5);d.set_m_restitution(a.restitution||0);c=new Ammo.btRigidBody(d);0!==a.mass?(c.setCollisionFlags(a.flag||
0),world.addRigidBody(c,a.group||1,a.mask||-1),c.setActivationState(a.state||1)):(c.setCollisionFlags(a.flag||1),world.addCollisionObject(c,a.group||1,a.mask||-1));a.name?byName[a.name]=c:0!==a.mass&&(byName[bodys.length]=c);0!==a.mass?bodys.push(c):solids.push(c);Ammo.destroy(d)};function stepSoftBody(a,b){var d=b;softs.forEach(function(b){b=b.get_m_nodes();for(var e=b.size(),f;e--;)f=d+3*e,b.at(e).get_m_x().toArray(a,f);d+=3*b.size()})}function moveSoftBody(a){a=softs[a.id];for(var b=a.get_m_nodes(),d=b.size();d--;);a.set_m_nodes(b)}function clearSoftBody(){for(var a;0<softs.length;)a=softs.pop(),world.removeSoftBody(a),Ammo.destroy(a);softs=[]}
function addSoftBody(a){var b=a.gendiags||!0;a.size=void 0==a.size?[1,1,1]:a.size;a.div=void 0==a.div?[64,64]:a.div;var d=new Ammo.btSoftBodyHelpers,c;switch(a.type){case "cloth":c=0.5*a.size[0];var e=0.5*a.size[2];tmpPos1.fromArray([-c,0,-e]);tmpPos2.fromArray([c,0,-e]);tmpPos3.fromArray([-c,0,e]);tmpPos4.fromArray([c,0,e]);c=d.CreatePatch(worldInfo,tmpPos1,tmpPos2,tmpPos3,tmpPos4,a.div[0],a.div[1],a.fixed||0,b);c.softType=1;break;case "rope":tmpPos1.fromArray(a.start||[-10,0,0]);tmpPos2.fromArray(a.end||
[10,0,0]);c=a.numSegment||10;a.margin=a.radius||0.2;c=d.CreateRope(worldInfo,tmpPos1,tmpPos2,c-2,a.fixed||0);c.softType=2;break;case "ellipsoid":tmpPos1.fromArray(a.center||[0,0,0]);tmpPos2.fromArray(a.radius||[3,3,3]);c=d.CreateEllipsoid(worldInfo,tmpPos1,tmpPos2,a.vertices||128);c.softType=3;for(var b=[],e=c.get_m_nodes(),f=e.size(),h;f--;)d=3*f,h=e.at(f),h=h.get_m_x(),b[d]=h.x(),b[d+1]=h.y(),b[d+2]=h.z();a.lng=e.size();a.a=b;self.postMessage({m:"ellipsoid",o:a});break;case "softConvex":c=d.CreateFromConvexHull(worldInfo,
a.v,a.v.length/3,a.randomize||!1);c.softType=4;for(b=a.v.length/3;b--;)d=3*b,tmpPos.fromArray(a.v,d),c.get_m_nodes().at(b).set_m_x(tmpPos);break;case "softTriMesh":c=d.CreateFromTriMesh(world.getWorldInfo(),a.v,a.i,a.ntri,a.randomize||!0),c.softType=5}d=c.get_m_cfg();void 0!==a.viterations&&d.set_viterations(a.viterations);void 0!==a.piterations&&d.set_piterations(a.piterations);void 0!==a.citerations&&d.set_citerations(a.citerations);void 0!==a.diterations&&d.set_diterations(a.diterations);d.set_collisions(17);
void 0!==a.kdf&&d.set_kDF(a.kdf);void 0!==a.kdp&&d.set_kDP(a.kdp);void 0!==a.kpr&&d.set_kPR(a.kpr);void 0!==a.kvc&&d.set_kVC(a.kvc);void 0!==a.klst&&c.get_m_materials().at(0).set_m_kLST(a.klst);void 0!==a.kast&&c.get_m_materials().at(0).set_m_kAST(a.kast);void 0!==a.kvst&&c.get_m_materials().at(0).set_m_kVST(a.kvst);c.setTotalMass(a.mass,a.fromfaces||!1);void 0!==a.margin&&Ammo.castObject(c,Ammo.btCollisionObject).getCollisionShape().setMargin(a.margin);world.addSoftBody(c,a.group||1,a.mask||-1);
c.points=c.get_m_nodes().size();a.name&&(byName[a.name]=c);softs.push(c)};var tmpData={},terrainData={},terrainList=[],terrainNeedUpdate=!1;function terrainPostStep(a){var b=a.name;terrainList.push(b);tmpData[b]=a.hdata;terrainNeedUpdate=!0}function terrainUpdate(a){if(terrainNeedUpdate){for(;terrainList.length;)terrain_data(terrainList.pop());terrainNeedUpdate=!1}}
function addTerrain(a){a.name=void 0==a.name?"terrain":a.name;a.size=void 0==a.size?[1,1,1]:a.size;a.div=void 0==a.div?[64,64]:a.div;a.pos=void 0==a.pos?[0,0,0]:a.pos;a.quat=void 0==a.quat?[0,0,0,1]:a.quat;a.mass=void 0==a.mass?0:a.mass;var b=a.hdt||"PHY_FLOAT",d=void 0!==a.flipEdge?a.flipEdge:!0;tmpData[a.name]=a.hdata;terrain_data(a.name);b=new Ammo.btHeightfieldTerrainShape(a.div[0],a.div[1],terrainData[a.name],a.heightScale||1,-a.size[1],a.size[1],1,b,d);tmpPos2.setValue(a.size[0]/a.div[0],1,
a.size[2]/a.div[1]);b.setLocalScaling(tmpPos2);void 0!==a.margin&&void 0!==b.setMargin&&b.setMargin(a.margin);tmpPos.fromArray(a.pos);tmpQuat.fromArray(a.quat);tmpTrans.setIdentity();tmpTrans.setOrigin(tmpPos);tmpTrans.setRotation(tmpQuat);tmpPos1.setValue(0,0,0);d=new Ammo.btDefaultMotionState(tmpTrans);b=new Ammo.btRigidBodyConstructionInfo(a.mass,d,b,tmpPos1);a.friction=void 0==a.friction?0.5:a.friction;a.restitution=void 0==a.restitution?0:a.restitution;b.set_m_friction(a.friction||0.5);b.set_m_restitution(a.restitution||
0);d=new Ammo.btRigidBody(b);d.setCollisionFlags(a.flag||1);world.addCollisionObject(d,a.group||1,a.mask||-1);solids.push(d);Ammo.destroy(b)}function terrain_data(a){var b=tmpData[a],d=b.length,c;for(null==terrainData[a]&&(terrainData[a]=Ammo._malloc(4*d));d--;)c=4*d,Ammo.HEAPF32[terrainData[a]+c>>2]=b[d]};function stepVehicle(a,b){cars.forEach(function(d,c){var e=b+56*c,f,h,g;a[e+0]=d.getCurrentSpeedKmHour();d.getRigidBody().getMotionState().getWorldTransform(trans);trans.toArray(a,e+1);f=d.getNumWheels();4===f&&(h=40,a[e+h+0]=d.getWheelInfo(0).get_m_raycastInfo().get_m_suspensionLength(),a[e+h+1]=d.getWheelInfo(1).get_m_raycastInfo().get_m_suspensionLength(),a[e+h+2]=d.getWheelInfo(2).get_m_raycastInfo().get_m_suspensionLength(),a[e+h+3]=d.getWheelInfo(3).get_m_raycastInfo().get_m_suspensionLength());
for(;f--;)d.updateWheelTransform(f,!0),g=d.getWheelTransformWS(f),h=8*(f+1),g.toArray(a,e+h+1),0===f&&(a[e+h]=d.getWheelInfo(0).get_m_steering())})}function clearVehicle(){for(var a;0<cars.length;)a=cars.pop(),carsInfo.pop(),world.removeRigidBody(a.getRigidBody()),Ammo.destroy(a.getRigidBody()),world.removeAction(a);cars=[]}
function addVehicle(a){var b=a.type||"box";a.mass=void 0==a.mass?800:a.mass;a.masscenter=void 0==a.masscenter?[0,0,0]:a.masscenter;a.size=void 0==a.size?[2,0.5,4]:a.size;a.pos=void 0==a.pos?[0,0,0]:a.pos;a.quat=void 0==a.quat?[0,0,0,1]:a.quat;var d={steering:0,engine:0,breaking:0,incSteering:a.incSteering||0.04,maxSteering:a.maxSterring||0.3,incEngine:a.acceleration||10,maxEngine:a.engine||1E3,maxBreaking:a.maxBreaking||100},c;c="mesh"==b?addRigidBody({type:"mesh",v:a.v,mass:1},"isShape"):"convex"==
b?addRigidBody({type:"convex",v:a.v},"isShape"):addRigidBody({type:"box",size:a.size},"isShape");tmpPos4.fromArray(a.masscenter).negate();tmpTrans1.setIdentity();tmpTrans1.setOrigin(tmpPos4);b=new Ammo.btCompoundShape;b.addChildShape(tmpTrans1,c);tmpPos.fromArray(a.pos);tmpQuat.fromArray(a.quat);tmpTrans.setIdentity();tmpTrans.setOrigin(tmpPos);tmpTrans.setRotation(tmpQuat);tmpPos1.setValue(0,0,0);b.calculateLocalInertia(a.mass,tmpPos1);c=new Ammo.btDefaultMotionState(tmpTrans);b=new Ammo.btRigidBodyConstructionInfo(a.mass,
c,b,tmpPos1);b.set_m_friction(a.friction||0.5);b.set_m_restitution(a.restitution||0);b.set_m_linearDamping(a.linearDamping||0);b.set_m_angularDamping(a.angularDamping||0);c=new Ammo.btRigidBody(b);tmpPos2.setValue(0,0,0);tmpPos3.setValue(0,0,0);c.setAngularVelocity(tmpPos2);c.setLinearVelocity(tmpPos3);c.setActivationState(4);var e=new Ammo.btVehicleTuning;e.set_m_suspensionStiffness(a.s_stiffness||20);e.set_m_suspensionCompression(a.s_compression||0.84);e.set_m_suspensionDamping(a.s_damping||0.88);
e.set_m_maxSuspensionTravelCm(a.s_travel||100);e.set_m_maxSuspensionForce(a.s_force||1E4);var f=a.s_length||0.2,h=a.radius||0.4,g=a.wPos||[1,0,1.6];g[1]-=a.masscenter[1];e.set_m_frictionSlip(a.w_friction||1E3);var p=a.w_roll||0.1,k=new Ammo.btDefaultVehicleRaycaster(world),k=new Ammo.btRaycastVehicle(e,c,k);k.setCoordinateSystem(0,1,2);a=a.nw||4;for(var m,n,l=0;l<a;l++)2==l&&g[4]&&(g[0]+=g[4]),0==l&&(m=[g[0],g[1],g[2]],n=!0),1==l&&(m=[-g[0],g[1],g[2]],n=!0),2==l&&(m=[-g[0],g[1],-g[2]],n=!1),3==l&&
(m=[g[0],g[1],-g[2]],n=!1),4==l&&(m=[-g[0],g[1],-g[3]],n=!1),5==l&&(m=[g[0],g[1],-g[3]],n=!1),2==a&&1==l&&(m=[-g[0],g[1],-g[2]],n=!1),addWheel(k,m,h,e,f,p,n),k.setBrake(d.maxBreaking,l);world.addAction(k);world.addRigidBody(c);c.activate();cars.push(k);carsInfo.push(d);Ammo.destroy(b)}function addWheel(a,b,d,c,e,f,h){tmpPos1.fromArray(b);tmpPos2.setValue(0,-1,0);tmpPos3.setValue(-1,0,0);a.addWheel(tmpPos1,tmpPos2,tmpPos3,e,d,c,h).set_m_rollInfluence(f)}
function drive(a){a=a||0;if(cars[a]){var b=cars[a];a=carsInfo[a];var d=b.getNumWheels();a.steering-=a.incSteering*key[0];a.steering<-a.maxSteering&&(a.steering=-a.maxSteering);a.steering>a.maxSteering&&(a.steering=a.maxSteering);a.steering*=0.9;a.engine-=a.incEngine*key[1];a.engine>a.maxEngineForce&&(a.engine=a.maxEngine);a.engine<-a.maxEngineForce&&(a.engine=-a.maxEngine);0==key[1]&&(1<a.engine?a.engine*=0.9:-1>a.engine?a.engine*=0.9:(a.engine=0,a.breaking=a.maxBreaking));for(var c=d;c--;)0==c&&
b.setSteeringValue(a.steering,c),2!==d&&1==c&&b.setSteeringValue(a.steering,c),b.applyEngineForce(a.engine,c),b.setBrake(a.breaking,c)}};
